<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>
        tinder | Hẹn hò, kết bạn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- <link data-react-helmet="true" rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        #photo-block {
            display: flex;
            width: 100%;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 10px;
        }
    </style>


    <!-- <link rel="stylesheet" href="styles.css"> -->
</head>

<body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/CSSPlugin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/easing/EasePack.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.15.0/utils/Draggable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>

<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>  -->
<link href="/assets/profile/profile.css" rel="stylesheet"><!--
<link href='https://fonts.googleapis.com/css?family=Noto+Sans' rel='stylesheet' type='text/css'> -->
<div class="container-flug">
    <div class="side-bar">
        <div class="top-side-bar d-flex justify-content-between align-items-center">
            <div class="block-avatar d-flex justify-content-between align-items-center" style="margin-left: 8px;
    border-radius: 30px;">
                <a href="/login">
                    <img class="avatar me-2" src="https://cdn-icons-png.flaticon.com/512/520/520712.png">
                </a>
                <input type="hidden" id="idcurrent" th:value="${user.id}">
                <input type="hidden" id="username-current" th:value="${user.username}">
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="acount-action"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="acount-action"><i class="fa-solid fa-suitcase"></i></div>
                <div class="acount-action"><i class="fa-solid fa-shield-heart"></i></div>
            </div>
        </div>

        <div class="massage" style="background-color: #101418; height: 100%;">
<!--            <div class="tab-massage " style="flex-direction: columns; display:  flex;">-->
<!--                <div class="tab col-6">-->
<!--                    <button class="tab-button active" data-tab="tab1" style="width: 200px;">Các tương hợp</button>-->
<!--                </div>-->
<!--                <div class="tab col-6">-->
<!--                    <button class="tab-button" data-tab="tab2" style="width: 200px;">Tin nhắn</button>-->
<!--                </div>-->
<!--            </div>-->
            <div class="tab-content" style="display: block;margin-top: -15px">
                <div class="container">
                    <div class="text-color" style="margin: 20px 0">Account Settings</div>
                    <div class="d-flex justify-content-between alert alert-dark logout">
                        <span class="text-color">Email</span>
                        <span th:text="${user.getUserProfile().email}" class="text-color"></span>
                    </div>
                    <div class="d-flex justify-content-between alert alert-dark logout">
                        <span class="text-color">Phone Number</span>
                        <span th:text="${user.getUserProfile().phone}" class="text-color"></span>
                    </div>
                    <div class="text-color" style="margin: 20px 0">Discovery Settings</div>
                    <div class="d-flex justify-content-between alert alert-dark logout">
                        <span class="text-color">Location</span>
                        <span class="text-color">Hue, VietNam</span>
                    </div>
                    <div class="d-flex mb3 alert alert-dark logout">
                        <span class="text-color me-auto p-2">Looking for</span>
                        <div class="text-color-hover" style="padding-top: 5px;">
                            <span th:text="${user.getPreference().getGender()}" class="text-color p-2" style="margin-right: -15px"></span>
                            <span class="text-color p-2" style="font-size: 15px"><i class="fa-solid fa-chevron-right"></i></span>
                        </div>
                    </div>

                    <div class="alert alert-dark logout" style="padding-bottom: 3rem;height: 100px">
                        <p class="text-color">Age Preference</p>
                        <div id="ageRange">
                            <div class="d-flex justify-content-between" style="width: 107%;margin-left: -13px">
                                <input type="text" id="ageMin" readonly>
                                <input type="text" id="ageMax" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="text-color" style="margin: 20px 0">Display Preference</div>
                    <div class="d-flex mb3 alert alert-dark logout">
                        <span class="text-color me-auto p-2">Language</span>
                        <div class="text-color-hover" style="padding-top: 5px;">
                            <span class="text-color p-2" style="margin-right: -15px">English</span>
                            <span class="text-color p-2" style="font-size: 15px"><i class="fa-solid fa-chevron-right"></i></span>
                        </div>
                    </div>
                    <div id="tab1" class="alert alert-dark text-center logout" style="margin-top: 25px">
                        <a href="http://localhost:8080/logout" style="width: 100%;margin-left: 0;text-decoration: none;color: white">
                            Đăng xuất
                        </a>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <div class="wrapper" id="wrapper">
        <div class="scrollbar" id="style-defau  lt">
            <div class="force-overflow"></div>
            <img th:src="${user.getPhotos().get(0).getImageUrl()}" alt="" class="user-img">
            <div class="info-user">
                <div class="d-flex">
                    <H2 th:text="${userprofile.fullName}" style="margin-right: 10px"></H2>
                    <H2 th:text="${userprofile.age}"></H2>
                </div>
                <p><i class="fa-solid fa-house" style="padding: 5px 5px;line-height: 15px"></i>Sống ở huế</p>
                <span class="d-flex"><i class="fas fa-user" style="padding: 5px 5px;line-height: 15px"></i><p
                        th:utext="${userprofile.getGender()}"></p></span>
                <span class="d-flex"><i class="fa-solid fa-envelope" style="padding: 5px 5px;line-height: 15px"></i><p
                        th:text="${userprofile.getEmail()}"></p></span>
                <span class="d-flex"><i class="fa fa-phone" style="padding: 5px 5px;line-height: 15px"></i>
                    <p th:text="${userprofile.getPhone()}"></p>
                </span>
                <div style="color: white;" class="interest">
                    <H2>Sở thích</H2>
                </div>
                <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                    <div class="d-flex flex-wrap">
                        <div th:each="interest, iterStat : ${interests}">
                            <input type="text" class="btn-check check" th:name="interest"
                                   th:id="'show' + ${iterStat.index+1}" autocomplete="off"
                                   th:value="${interest}">
                            <label class="btn btn-outline-secondary me-2 radius fw-bold"
                                   style="margin:10px; border-radius: 25px"
                                   th:for="'show' + ${iterStat.index+1}" th:text="${interest}"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="edit-info">
                <button class="btn-edit-info" onclick="showEdit(event)">Sửa thông tin</button>
            </div>
        </div>
    </div>
    <div class="wrapper2" id="wrapper2">
        <form method="post" th:object="${userprofile}" th:action="@{/profile}" role="form" enctype="multipart/form-data"
              id="formSubmit">
            <div class="scrollbar" id="style-default">
                <div class="message-edit">
                    <label class="form-label">Chỉnh sửa</label>

                </div>
                <div class="img-all">
                    <div class="d-flex upload-wrapper">
                        <label for="fullName" class="massage-edit2 form-label fw-bold">Ảnh của bạn</label>
                        <div id="photo-block">

                        </div>

                        <input type="hidden" name="id" th:field="*{id}" th:value="*{id}">


                        <label for="fullName" class="massage-edit2 form-label fw-bold">Full name</label>
                        <input id="fullName" name="fullName" class="form-control" th:value="${userprofile.fullName}"
                               th:field="*{fullName}" oninput="onInput(this)" onfocus="onFocus(this)"
                               onblur="onBlur(this)"/>
                        <span id="fullName-error" class="invalid-feedback"></span>


                        <label for="email" class="massage-edit2 form-label fw-bold">Email</label>
                        <input id="email" name="email" class="form-control" th:value="${userprofile.email}"
                               th:field="*{email}" oninput="onInput(this)" onfocus="onFocus(this)" onblur="onBlur(this)"/>
                        <span id="email-error" class="invalid-feedback"></span>
                        <span id="email-error-submit" th:errors="*{email}" class="invalid-feedback"
                                th:if="${#fields.hasErrors('email')}"></span>


                        <label for="phone" class="massage-edit2 form-label fw-bold">Phone</label>
                        <input id="phone" name="phone" class="form-control" th:value="${userprofile.phone}"
                               th:field="*{phone}" oninput="onInput(this)" onfocus="onFocus(this)"
                               onblur="onBlur(this)"/>
                        <span id="phone-error" class="invalid-feedback"></span>
                        <span th:errors="*{phone}" class="invalid-feedback"
                              th:if="${#fields.hasErrors('phone')}"></span>


                        <label for="age" class="massage-edit2 form-label fw-bold">Age</label>
                        <input type="number" id="age" name="age" class="form-control" th:value="${userprofile.age}"
                               th:field="*{age}" oninput="onInput(this)" onfocus="onFocus(this)" onblur="onBlur(this)"/>
                        <span id="age-error" class="invalid-feedback"></span>


                        <label class="massage-edit2 form-label fw-bold">Gender</label>
                        <div class="d-flex justify-content-between">
                            <div th:each="gender, iterStat : ${genders}">
                                <input type="radio" class="btn-check" th:name="options"
                                       th:id="'option' + ${iterStat.index+1}" autocomplete="off"
                                       th:value="${gender}" th:field="*{gender}"/>
                                <label style="width: 105px" class="btn btn-outline-secondary me-2 radius fw-bold"
                                       th:for="'option' + ${iterStat.index+1}" th:text="${gender}"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div id="interestModal" class="modal">
                        <div class="modal-content">
                            <div class="d-flex justify-content-between">
                                <h3>Chọn sở thích</h3>
                                <button onclick="hideInterests(event)" class="btn-close">
                                </button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                                <div class="d-flex">
                                    <div th:each="interest, iterStat : ${allInterests}">
                                        <input type="checkbox" class="btn-check check" th:name="interest"
                                               th:id="'btncheck' + ${iterStat.index+1}" autocomplete="off"
                                               th:value="${interest}"
                                               onclick="selectInterest('${interest}')">
                                        <label class="btn btn-outline-secondary me-2 radius fw-bold" style="margin:15px"
                                               th:for="'btncheck' + ${iterStat.index+1}" th:text="${interest}"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <button id="interestSubmitBtn" type="button" class="btn btn-primary radius fw-bold"
                                        onclick="saveInterests()" style="padding: 5px 20px;margin: 20px auto">
                                    Chọn
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="div-mr">
                        <label class="massage-edit2 form-label fw-bold">Interest</label><br>
                        <div class="showInterests">
                            <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                                <div class="d-flex flex-wrap">
                                    <div th:each="interest, iterStat : ${interests}">
                                        <input type="text" class="btn-check check" th:name="interest"
                                               th:id="'btn-' + ${iterStat.index+1}" autocomplete="off"
                                               th:value="${interest}">
                                        <label class="btn btn-outline-secondary me-2 radius fw-bold" style="margin:5px"
                                               th:for="'btn-' + ${iterStat.index+1}" th:text="${interest}"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin: 5px 5px">
                            <button onclick="showInterests(event)"
                                    class="btn btn-outline-secondary radius fw-bold btn-edit-info2">
                                <i class="fas fa-plus" style="color: red"></i>
                                Thêm sở thích
                            </button>
                        </div>
                    </div>
                </div>
                <div class="text-center" style="margin: 20px">
                    <button type="submit" class="btn btn-danger radius fw-bold" onclick="checkSubmit(event)">
                        Sửa thông tin
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>

</body>
<script>

    let previousMinAge = 16;
    let previousMaxAge = 69;
    $(function () {
        $("#ageRange").slider({
            range: true,
            min: 16,
            max: 69,
            values: [16, 69],
            slide: function (event, ui) {
                $("#ageMin").val(ui.values[0]);
                $("#ageMax").val(ui.values[1]);
                ageMin = parseInt($("#ageMin").val());
                ageMax = parseInt($("#ageMax").val());
                body.innerHTML = '';
                if (ageMin !== previousMinAge || ageMax !== previousMaxAge) {
                    // filterProductsByPrice(ageMin, ageMax);
                    previousMinAge = ageMin;
                    previousMaxAge = ageMax;
                }
            }
        });
        $("#ageMin").val($("#ageRange").slider("values", 0));
        $("#ageMax").val($("#ageRange").slider("values", 1));
    });


    // function filterProductsByPrice(ageMin, ageMax) {
    //     let filteredAges = products.filter(function (product) {
    //         return product.price >= minPrice && product.price <= maxPrice;
    //     });
    //     return filteredProducts;
    // }

    function onFilter() {
        minAge = document.getElementById('min').value;
        maxAge = document.getElementById('max').value;
    }
    function renderPhoto() {
        $.ajax({
            url: "/api/users/getPhoto",
            method: "GET",
            contentType: "application/json",
            success: function (response) {
                let matchE = document.getElementById("photo-block");
                let html = ``
                let imgSrc = "https://via.placeholder.com/100x150"
                let photo = response.photos;
                for (let i = 0; i < 6; i++) {
                    if (photo && i < photo.length) {
                        imgSrc = photo[i].imageUrl
                    } else {
                        imgSrc = "https://via.placeholder.com/100x150"
                    }
                    html += `
                                   <div class="image-upload col-6">
                        <label for="file-input-${i + 1}">
                            <img class="preview-image-all" id="preview-image-${i + 1}"
                                 src=${imgSrc} width="100px"
                                 height="120px">
                        </label>
                        <div class="center">
                            <input class="input-upload" id="file-input-${i + 1}" type="file" name="fileUpload" multiple
                                   onchange="document.getElementById('preview-image-${i + 1}').src = window.URL.createObjectURL(this.files[0])">
                        </div>
                    </div>`
                }
                matchE.innerHTML = html;
            },
            error: function (error) {
                console.log("Đã có lỗi xảy ra: " + error);
            }
        })
    }

    renderPhoto()

    function showEdit(event) {
        // event.preventDefault();
        const editModal = document.getElementById("wrapper2");
        const profileModal = document.getElementById("wrapper")
        editModal.style.display = "flex";
        profileModal.style.display = "none"
    }

    function checkSubmit(event) {
        event.preventDefault();


        let selectedInterests = JSON.parse(sessionStorage.getItem('selectedInterests'));

        let checkboxes = document.querySelectorAll('#interestModal input[type="checkbox"]');

        sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));
        checkboxes.forEach(function (checkbox) {
            if (selectedInterests.includes(checkbox.value)) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });

        const invalidElements = document.getElementsByClassName("is-invalid");

        const checkboxInputs = document.querySelectorAll('input[type="checkbox"]');
        let isChecked = false;
        for (const inter of checkboxInputs) {
            if (inter.checked) {
                isChecked = true;
                break;
            }
        }
        if (invalidElements.length > 0) {
            swal.fire({
                icon: 'error',
                title: 'Error',
                text: "There are errors on the form. Please correct them before submitting.",
            });
        } else if (!isChecked) {
            swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please add at least 1 interest to continue',
            });
        } else {
            const form = document.getElementById("formSubmit");
            form.submit();
        }
    }

    function showInterests(event) {
        event.preventDefault();
        const interestModal = document.getElementById("interestModal");
        interestModal.style.display = "block";
        let selectedInterests = JSON.parse(sessionStorage.getItem('selectedInterests'));

        let checkboxes = document.querySelectorAll('#interestModal input[type="checkbox"]');

        sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));
        checkboxes.forEach(function (checkbox) {
            if (selectedInterests.includes(checkbox.value)) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });
    }

    function hideInterests() {
        event.preventDefault();
        const interestModal = document.getElementById("interestModal");
        interestModal.style.display = "none";

        let selectedInterests = JSON.parse(sessionStorage.getItem('selectedInterests'));
        let checkboxes = document.querySelectorAll('#interestModal input[type="checkbox"]');

        sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));
        checkboxes.forEach(function (checkbox) {
            if (selectedInterests.includes(checkbox.value)) {
                checkbox.checked = true;
            } else {
                checkbox.checked = false;
            }
        });
    }

    function selectInterest(interest) {
        window.preventDefault();
        const interestOption = document.querySelector(`.interest-option[data-interest="${interest}"]`);
        interestOption.classList.toggle("selected");
    }

    function saveInterests() {
        showInterestedChecked();

        let checkboxes = document.querySelectorAll('#interestModal input[type="checkbox"]');
        let isChecked = false;
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                isChecked = true;
                break;
            }
        }
        if (!isChecked) {
            swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please select at least one interest',
            });
            return;
        }
        let selectedInterests = [];
        for (let i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) {
                selectedInterests.push(checkboxes[i].value);
            }
        }
        sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));

        hideInterests();
    }

    function showInterestedChecked() {
        let checkboxes = document.querySelectorAll('#interestModal input[type="checkbox"]');
// Lặp qua từng checkbox và lưu giá trị đã chọn vào một mảng
        let selectedInterests = [];
        checkboxes.forEach(function (checkbox) {
            if (checkbox.checked) {
                selectedInterests.push(checkbox.value);
            }
        });
// Lưu mảng các giá trị đã chọn vào session storage
        sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));
// Tạo các phần tử HTML để hiển thị các giá trị đã chọn
        const showInterestsDiv = document.querySelector(".showInterests");
        showInterestsDiv.innerHTML = "";
        for (const interest of selectedInterests) {
            const interestElement = document.createElement("span");
            interestElement.textContent = interest;
            interestElement.classList.add("blabla", "custom-css-class")
            const selectedShowOptions = document.getElementsByClassName('blabla');
            const closeButton = document.createElement("i");
            closeButton.classList.add("fas", "fa-times");
            closeButton.style.color = "red";
            closeButton.addEventListener("click", function () {
                this.parentNode.parentNode.removeChild(this.parentNode);
                // Xóa giá trị đã chọn khỏi mảng selectedInterests
                let index = selectedInterests.indexOf(interest);
                if (index !== -1) {
                    selectedInterests.splice(index, 1);
                }
                // Cập nhật lại session storage
                sessionStorage.setItem('selectedInterests', JSON.stringify(selectedInterests));
                // Cập nhật lại các checkbox trong modal
                checkboxes.forEach(function (checkbox) {
                    if (selectedInterests.includes(checkbox.value)) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                    }
                });
            });
            interestElement.appendChild(closeButton);
            showInterestsDiv.appendChild(interestElement);
        }
    }

    function disPlayImagelocalStorage() {
        const savedImages = localStorage.getItem('savedImages');
        if (savedImages) {
            const imageUrls = JSON.parse(savedImages);
            for (let i = 0; i < imageUrls.length; i++) {
                const imageUrl = imageUrls[i];
                const imgElement = document.getElementById(`preview-image-${i + 7}`);
                imgElement.src = imageUrl;
            }
        }
    }
    disPlayImagelocalStorage();

    const onBlur = (input) => {
        let errorStatus = checkInput(input)
        if (!errorStatus.error) {
            isUsernameError = true;
            document.getElementById(input.id + '-error').innerText = errorStatus.message;
        } else {
            isUsernameError = false;
            document.getElementById(input.id + '-error').innerText = "";
        }
        input.classList.remove("is-invalid", "is-valid");
        input.classList.add(isUsernameError ? "is-invalid" : "is-valid");
    }
    const onInput = (input) => {
        let errorStatus = checkInput(input)
        isUsernameError = !errorStatus.error;
        input.classList.remove("is-invalid", "is-valid");
        input.classList.add(isUsernameError ? "is-invalid" : "is-valid");
    }
    const onFocus = (input) => {
        document.getElementById(input.id + '-error').innerText = "";
        document.getElementById(input.id + '-error-submit').innerText = "";
    }

    function checkInput(input) {
        let value = input.value;
        let regex;
        let message;
        switch (input.id) {
            case "fullName":
                if (value === "") {
                    message = "Full name can't be empty";
                    return {
                        error: false,
                        message
                    }
                } else {
                    regex = /^[a-zA-ZÀ-Ỹà-ỹ]+( [a-zA-ZÀ-Ỹà-ỹ]+)*$/;
                    message = "Full name can't have special characters";
                    return {
                        error: regex.test(value),
                        message
                    }
                }
            case "email":
                if (value === "") {
                    message = "Email can't be empty";
                    return {
                        error: false,
                        message
                    }
                } else {
                    regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.(com|edu|net|org|biz|info|vn|pro)$/;
                    message = "Email with invalid domain name";
                    return {
                        error: regex.test(value),
                        message
                    }
                }
            case "phone":
                if (value === "") {
                    message = "Phone can't be empty";
                    return {
                        error: false,
                        message
                    }
                } else {
                    regex = /^[0][0-9]{9}$/;
                    message = "Phone number must have 10 digits and start with 0";
                    return {
                        error: regex.test(value),
                        message
                    }
                }
            case "age":
                if (value === "") {
                    message = "Age can't be empty";
                    return {
                        error: false,
                        message
                    }
                } else if (value < 16 || value > 69) {
                    message = "Age must be between 16 and 69";
                    return {
                        error: false,
                        message
                    }
                } else {
                    regex = /^\d+$/;
                    message = "Age is only allowed to enter numbers";
                    return {
                        error: regex.test(value),
                        message
                    }
                }
        }
    }
</script>
</html>

